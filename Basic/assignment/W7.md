> ## 6-1 Intro
---

### 이번 파트에서 다룰 내용

```
- 가독성을 챙기기 위한 SQL 스타일 가이드
- 데이터 결과 검증
```

> ## 6-2 가독성을 챙기기 위한 SQL 스타일 가이드
---

### 데이터 결과 검증을 하기 전에

```
실수의 발생 :

1. 문법을 잘못 알고 있는 경우
2. 데이터를 파악하지 않고 쿼리를 작성하는 경우
3. 쿼리가 복잡한 경우 -> 단순화 필요
```

### 가독성을 챙기기 위한 SQL 스타일 가이드


https://docs.telemetry.mozilla.org/concepts/sql_style.html

### 1. 예약어는 대문자로 작성

```
예약어 : SELECT, FROM, WHERE 등 각종 함수
```

### 2. 컬럼 이름은 snake_case로 작성

```
컬럼 이름은 CamelCase가 아닌 snake_case로 작성
: 일관성 중요!!
```

### 3. 명시적 vs 암시적인 이름

```
- AS a, AS b등 컬럼의 이름을 명시적인 것으로 사용
- JOIN할 때 또한 테이블의 이름을 명시적으로 하기
```

### 4. 왼쪽 정렬

```
기본적으로 왼쪽 정렬을 기준으로 작성하기

SELECT
 col
FROM table
WHERE 1=1
```

### 5. 예약어나 컬럼은 한 줄에 하나씩 권장

```
컬럼을 바로 주석 처리할 수 있게 한 줄에 하나씩 작성

SELECT
 col1,
 col2,
 col3
FROM table
WHERE
```

### 6. 쉼표는 컬럼 바로 뒤에

```
SELECT
 col1,
 col2,
 col3,
FROM table
```

> ## 6-3 가독성을 챙기기 위한 WITH문 & 파티션
---

### WITH 구문

```
SQL 쿼리를 작성하면 생기는 일
 =>점점 복잡해 져 가독성 하락

WITH : 쿼리의 최상단에 위치

WITH temp_table AS(
 SELECT
  col, col2, col3…
 FROM
  Table
)

SELECT
 col, col2
FROM temp_table

- CTE(Common Table Expression)라고 표현
- 쿼리 내에서 반복적으로 사용 가능

WITH base AS로 시작하는 것을 추천
```

### PARTITION

```
Table엔 Partition이란 것이 존재할 수 있음

일반적으로 Partition에 DATE 데이터를 많이 사용
```
![img](/img/image-117.png)

### PARTITION을 사용하면 좋은 점

```
(1) 쿼리 성능 향상 :
- 전체 데이터를 스캔하는 것 보다 파티션을 설정한 곳만 스캔하는 것이 더 빠름

(2) 데이터 관리의 용이성 :
- 특정 일자의 데이터를 모두 변경하거나 삭제해야 하면 파티션을 설정해서 삭제할 수 있음

(3)비용 :
- 파티션에 해당되는 데이터만 스캔해서 비용을 줄일 수 있음(BigQuery는 쿼리 용량에 비례해서 과금)

DATETIME_ADD('년-월-일', INTERVAL 1 DAY)
 : 해당하는 날짜에 +1을 해주는 함수
```

> ## 6-4 데이터 결과 검증 정의
---

### 데이터 결과 검증을 잘하기 위한 마인드셋

```
- 데이터 결과 검증을 하지 못해서 실수가 날 수도 있음
 : 항상 그 실수 이후에 어떻게 해야 다시 반복되지 않을지 생각하는 것이 필요(회고도 필수)
```

### 데이터 결과 검증(Data Result Validation)의 정의

```
목적 : 분석 결과의 정확성 및 신뢰성 확보

방법 :

- 내가 예상하는 결과를 정의
- 쿼리 작성
- 두 개가 일치하는지 비교하기

제일 중요한 부분 :

- 문제를 잘 정의하고 미리 작성해보기
- 도메인 특수성을 잘 파악하기
- SQL 쿼리 템플릿과 맥락이 유사
```

### 데이터 결과를 검증하는 흐름

![img](/img/image-118.png)


### 데이터 결과 검증할 때 자주 활용하는 SQL 쿼리

```
대표적으로 활용하는 SQL 문법 :

(1) COUNT(*) : 행수를 확인
 : 의도한 데이터의 행 개수가 맞는지

 ex) SELECT COUNT(DISTINCT col)과 COUNT(col)
 : => 두 개의 개수를 비교

(2) NOT NULL : 특정 컬럼에 NULL이 존재하는지 확인
 : 필수 필드가 비어있지는 않은지

(3) DISTINCT : 데이터의 고유값을 확인 및 중복 여부 확인

(4) IF문, CASE WHEN
 : 의도와 같다면 TRUE 아니면 FALSE
```
### 제가 데이터 결과 검증을 할 때 활용하는 방식

```
(1) 특정user_id로 필터링을 걸어서 확인 :

- 1명의 데이터 확인
 : ex.WHERE user_id = 402

- 결과를 예상할 때 Raw데이터에서 하나씩 눈으로 세고 예상결과를 적어둠

- 1명의 데이터의 예상결과와 쿼리결과가 동일한지 확인

- 다른user_id 3~4건 더 추가해서 확인
 : 여러 케이스가 존재할 수 있기 때문

- 3~4개에서 동일한 결과가 나오면 user_id 조건을 삭제

(2) 샘플 데이터 생성 :

- WITH문을 사용해 예시 데이터를 생성한 후 결과를 예상하고 쿼리 작성

- 복잡한 데이터에서 하기 전에 쿼리 자체가 올바른지 확인할 때 주로 사용

UNION ALL : ROW 단위로 합치는 것을 의미
 : CONCAT의 개념(아래로 붙임)
```
![img](/img/image-119.png)

> ## 6-5 데이터 결과 검증 예시
---

### 데이터 결과 검증 예시 문제

```
예시 문제 :
여러분은 포켓몬 트레이너들의 배틀성적을 분석하는 작업을 맡게 되었습니다.
각 트레이너가 진행한 배틀의 승리 비율을 계산해야 하며, 배틀에 참여한 횟수가 9회 이상인 경우만 계산합니다.

데이터 결과 검증 프로세스 흐름 :

(1) 전체 데이터 파악
(2) 특정 user_id 선정
(3) 승률 직접 COUNT : 결과 예상
(4) 쿼리 작성
(5) 실제와 비교
(6) 맞다면 특정 유저 조건 제외
```
![img](/img/image-120.png)
![img](/img/image-121.png)
![img](/img/image-122.png)
![img](/img/image-123.png)
![img](/img/image-124.png)

> ## 6-6 정리
---